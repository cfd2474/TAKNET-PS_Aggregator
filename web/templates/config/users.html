{% extends "base.html" %}
{% block page_title %}User Management{% endblock %}
{% block content %}

<!-- Pending Requests -->
{% if pending_users %}
<div class="card" style="max-width:800px;margin-bottom:20px;border-color:rgba(234,179,8,0.4);">
    <div class="card-header" style="background:rgba(234,179,8,0.06);">
        <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:16px;">⚠️</span>
            <h3 style="color:#eab308;">Pending Access Requests</h3>
        </div>
        <span style="font-size:12px;color:var(--text-muted);">{{ pending_users|length }} pending</span>
    </div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>Username</th><th>Requested</th><th>Approve As</th><th style="text-align:right;">Actions</th></tr></thead>
            <tbody>
            {% for u in pending_users %}
            <tr id="pending-row-{{ u.id }}">
                <td style="font-weight:500;color:var(--text-primary);font-family:monospace;">{{ u.username }}</td>
                <td style="font-size:12px;color:var(--text-muted);">{{ u.created_at[:16] }}</td>
                <td>
                    <select id="pending-role-{{ u.id }}" class="form-control" style="padding:4px 8px;font-size:12px;width:auto;">
                        {% for r in roles %}
                        <option value="{{ r }}">{{ r }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td style="text-align:right;display:flex;gap:6px;justify-content:flex-end;">
                    <button class="btn" style="font-size:11px;padding:4px 12px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.4);color:#22c55e;"
                            onclick="approveUser({{ u.id }})">Approve</button>
                    <button class="btn btn-danger" style="font-size:11px;padding:4px 12px;"
                            onclick="denyUser({{ u.id }}, '{{ u.username }}')">Deny</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Active Users -->
<div class="card" style="max-width:800px;">
    <div class="card-header">
        <h3>Users</h3>
        <button class="btn btn-primary" onclick="showAddModal()" style="font-size:12px;">+ Add User</button>
    </div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>
            {% for u in users %}
            <tr id="user-row-{{ u.id }}">
                <td style="font-weight:500;color:var(--text-primary);font-family:monospace;">{{ u.username }}</td>
                <td>
                    <select class="form-control" style="padding:4px 8px;font-size:12px;width:auto;"
                            onchange="changeRole({{ u.id }}, this.value)"
                            {% if u.id == current_user.id|int %}disabled{% endif %}>
                        {% for r in roles %}
                        <option value="{{ r }}" {% if r == u.role %}selected{% endif %}>{{ r }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td style="font-size:12px;color:var(--text-muted);">{{ u.created_at[:10] }}</td>
                <td style="display:flex;gap:6px;">
                    <button class="btn" style="font-size:11px;padding:4px 10px;"
                            onclick="showResetModal({{ u.id }}, '{{ u.username }}')">Reset PW</button>
                    {% if u.id != current_user.id|int %}
                    <button class="btn btn-danger" style="font-size:11px;padding:4px 10px;"
                            onclick="deleteUser({{ u.id }}, '{{ u.username }}')">Delete</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="add-modal">
    <div class="modal" style="max-width:420px;">
        <div class="modal-header">
            <h3>Add User</h3>
            <button class="modal-close" onclick="closeModal('add-modal')">&#x2715;</button>
        </div>
        <div class="modal-body">
            <div id="add-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:10px;font-size:13px;color:var(--red);margin-bottom:14px;"></div>
            <div class="form-group"><label>Username</label><input class="form-control" type="text" id="add-username" autocomplete="off"></div>
            <div class="form-group"><label>Password</label><input class="form-control" type="password" id="add-password" autocomplete="new-password"></div>
            <div class="form-group">
                <label>Role</label>
                <select class="form-control" id="add-role">
                    {% for r in roles %}<option value="{{ r }}">{{ r }}</option>{% endfor %}
                </select>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
                <button class="btn" onclick="closeModal('add-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" id="reset-modal">
    <div class="modal" style="max-width:380px;">
        <div class="modal-header">
            <h3>Reset Password</h3>
            <button class="modal-close" onclick="closeModal('reset-modal')">&#x2715;</button>
        </div>
        <div class="modal-body">
            <div id="reset-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:10px;font-size:13px;color:var(--red);margin-bottom:14px;"></div>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Set new password for <strong id="reset-username"></strong></p>
            <div class="form-group"><label>New Password</label><input class="form-control" type="password" id="reset-password" autocomplete="new-password"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
                <button class="btn" onclick="closeModal('reset-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let resetTargetId = null;

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showAddModal() { document.getElementById('add-error').style.display='none'; document.getElementById('add-username').value=''; document.getElementById('add-password').value=''; document.getElementById('add-modal').classList.add('show'); }
function showResetModal(id, name) { resetTargetId = id; document.getElementById('reset-username').textContent = name; document.getElementById('reset-password').value = ''; document.getElementById('reset-error').style.display='none'; document.getElementById('reset-modal').classList.add('show'); }

async function approveUser(id) {
    const role = document.getElementById('pending-role-' + id).value;
    const r = await fetch('/config/users/' + id + '/approve', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({role}) });
    const d = await r.json();
    if (d.success) {
        document.getElementById('pending-row-' + id).remove();
        location.reload();
    } else { alert('Error: ' + d.error); }
}

async function denyUser(id, name) {
    if (!confirm('Deny access request for "' + name + '"? They will be unable to log in.')) return;
    const r = await fetch('/config/users/' + id + '/deny', { method: 'POST' });
    const d = await r.json();
    if (d.success) { document.getElementById('pending-row-' + id).remove(); }
    else { alert('Error: ' + d.error); }
}

async function createUser() {
    const username = document.getElementById('add-username').value.trim();
    const password = document.getElementById('add-password').value;
    const role = document.getElementById('add-role').value;
    const errEl = document.getElementById('add-error');
    if (!username || !password) { errEl.textContent = 'Username and password required.'; errEl.style.display='block'; return; }
    const r = await fetch('/config/users/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password, role}) });
    const d = await r.json();
    if (d.success) { location.reload(); }
    else { errEl.textContent = d.error || 'Error creating user'; errEl.style.display='block'; }
}

async function changeRole(id, role) {
    const r = await fetch('/config/users/' + id + '/role', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role}) });
    const d = await r.json();
    if (!d.success) { alert('Error: ' + (d.error || 'Could not update role')); location.reload(); }
}

async function resetPassword() {
    const password = document.getElementById('reset-password').value;
    const errEl = document.getElementById('reset-error');
    if (password.length < 6) { errEl.textContent = 'Password must be at least 6 characters.'; errEl.style.display='block'; return; }
    const r = await fetch('/config/users/' + resetTargetId + '/reset-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password}) });
    const d = await r.json();
    if (d.success) { closeModal('reset-modal'); }
    else { errEl.textContent = d.error || 'Error resetting password'; errEl.style.display='block'; }
}

async function deleteUser(id, name) {
    if (!confirm('Delete user "' + name + '"? This cannot be undone.')) return;
    const r = await fetch('/config/users/' + id + '/delete', { method:'POST' });
    const d = await r.json();
    if (d.success) { document.getElementById('user-row-' + id).remove(); }
    else { alert('Error: ' + d.error); }
}
</script>
{% endblock %}
