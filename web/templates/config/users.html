{% extends "base.html" %}
{% block page_title %}User Management{% endblock %}
{% block content %}

<!-- Users table -->
<div class="card" style="max-width:800px;">
    <div class="card-header">
        <h3>Users</h3>
        <button class="btn btn-primary" onclick="showAddModal()" style="font-size:12px;">+ Add User</button>
    </div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>
            {% for u in users %}
            <tr id="user-row-{{ u.id }}">
                <td style="font-weight:500;color:var(--text-primary);font-family:monospace;">{{ u.username }}</td>
                <td>
                    <select class="form-control" style="padding:4px 8px;font-size:12px;width:auto;"
                            onchange="changeRole({{ u.id }}, this.value)"
                            {% if u.id == current_user.id|int %}disabled{% endif %}>
                        {% for r in roles %}
                        <option value="{{ r }}" {% if r == u.role %}selected{% endif %}>{{ r }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td style="font-size:12px;color:var(--text-muted);">{{ u.created_at[:10] }}</td>
                <td style="display:flex;gap:6px;">
                    <button class="btn" style="font-size:11px;padding:4px 10px;"
                            onclick="showResetModal({{ u.id }}, '{{ u.username }}')">Reset PW</button>
                    {% if u.id != current_user.id|int %}
                    <button class="btn btn-danger" style="font-size:11px;padding:4px 10px;"
                            onclick="deleteUser({{ u.id }}, '{{ u.username }}')">Delete</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="add-modal">
    <div class="modal" style="max-width:420px;">
        <div class="modal-header">
            <h3>Add User</h3>
            <button class="modal-close" onclick="closeModal('add-modal')">&#x2715;</button>
        </div>
        <div class="modal-body">
            <div id="add-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:10px;font-size:13px;color:var(--red);margin-bottom:14px;"></div>
            <div class="form-group">
                <label>Username</label>
                <input class="form-control" type="text" id="add-username" autocomplete="off">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input class="form-control" type="password" id="add-password" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select class="form-control" id="add-role">
                    {% for r in roles %}
                    <option value="{{ r }}">{{ r }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
                <button class="btn" onclick="closeModal('add-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" id="reset-modal">
    <div class="modal" style="max-width:380px;">
        <div class="modal-header">
            <h3>Reset Password</h3>
            <button class="modal-close" onclick="closeModal('reset-modal')">&#x2715;</button>
        </div>
        <div class="modal-body">
            <div id="reset-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:10px;font-size:13px;color:var(--red);margin-bottom:14px;"></div>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">
                Set new password for <strong id="reset-username" style="color:var(--text-primary);"></strong>
            </p>
            <input type="hidden" id="reset-user-id">
            <div class="form-group">
                <label>New Password</label>
                <input class="form-control" type="password" id="reset-password" autocomplete="new-password" minlength="6">
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;">
                <button class="btn" onclick="closeModal('reset-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="resetPassword()">Update Password</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function showAddModal() {
    document.getElementById('add-username').value = '';
    document.getElementById('add-password').value = '';
    document.getElementById('add-role').value = 'viewer';
    document.getElementById('add-error').style.display = 'none';
    document.getElementById('add-modal').classList.add('show');
    document.getElementById('add-username').focus();
}

function showResetModal(id, username) {
    document.getElementById('reset-user-id').value = id;
    document.getElementById('reset-username').textContent = username;
    document.getElementById('reset-password').value = '';
    document.getElementById('reset-error').style.display = 'none';
    document.getElementById('reset-modal').classList.add('show');
    document.getElementById('reset-password').focus();
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

async function createUser() {
    const username = document.getElementById('add-username').value.trim();
    const password = document.getElementById('add-password').value;
    const role = document.getElementById('add-role').value;
    const errEl = document.getElementById('add-error');

    if (!username || !password) {
        showErr(errEl, 'Username and password are required.');
        return;
    }

    try {
        const r = await fetch('/config/users/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password, role})
        });
        const d = await r.json();
        if (d.success) {
            closeModal('add-modal');
            location.reload();
        } else {
            showErr(errEl, d.error || 'Failed to create user.');
        }
    } catch(e) {
        showErr(errEl, 'Request failed: ' + e);
    }
}

async function changeRole(userId, role) {
    try {
        const r = await fetch(`/config/users/${userId}/role`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({role})
        });
        const d = await r.json();
        if (!d.success) alert(d.error || 'Failed to update role.');
    } catch(e) {
        alert('Request failed: ' + e);
    }
}

async function resetPassword() {
    const userId = document.getElementById('reset-user-id').value;
    const password = document.getElementById('reset-password').value;
    const errEl = document.getElementById('reset-error');

    if (password.length < 6) {
        showErr(errEl, 'Password must be at least 6 characters.');
        return;
    }

    try {
        const r = await fetch(`/config/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password})
        });
        const d = await r.json();
        if (d.success) {
            closeModal('reset-modal');
        } else {
            showErr(errEl, d.error || 'Failed to reset password.');
        }
    } catch(e) {
        showErr(errEl, 'Request failed: ' + e);
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
    try {
        const r = await fetch(`/config/users/${userId}/delete`, {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            document.getElementById('user-row-' + userId).remove();
        } else {
            alert(d.error || 'Failed to delete user.');
        }
    } catch(e) {
        alert('Request failed: ' + e);
    }
}

function showErr(el, msg) {
    el.textContent = msg;
    el.style.display = 'block';
}
</script>
{% endblock %}
