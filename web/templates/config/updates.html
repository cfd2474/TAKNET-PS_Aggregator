{% extends "base.html" %}
{% block page_title %}Updates{% endblock %}

{% block content %}
<!-- Version Check -->
<div class="card" style="max-width:700px;">
    <div class="card-header">
        <h3>Version Information</h3>
        <div style="display:flex;gap:8px;">
            <button class="btn" onclick="checkUpdate()" id="btn-check" style="font-size:12px;">Check Now</button>
            <button class="btn btn-primary" onclick="runUpdate()" id="btn-update" style="font-size:12px;display:none;">Run Update</button>
        </div>
    </div>
    <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:14px;">
        <span style="color:var(--text-muted)">Installed</span>
        <span style="font-weight:600;color:var(--text-primary);font-family:monospace;">v{{ version }}</span>
        <span style="color:var(--text-muted)">Latest</span>
        <span id="latest-version" style="font-family:monospace;">Checking...</span>
    </div>
    <div id="update-banner" style="display:none;margin-top:16px;padding:12px 16px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:8px;">
        <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">Update Available</div>
        <div style="font-size:13px;color:var(--text-secondary);">Click <strong>Run Update</strong> above, or run <code style="color:var(--green);">taknet-agg update</code> via SSH.</div>
    </div>
    <div id="uptodate-banner" style="display:none;margin-top:16px;padding:12px 16px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;">
        <span style="color:var(--green);font-weight:500;">&#10003; You're running the latest version</span>
    </div>
</div>

<!-- Release Notes -->
<div class="card" style="margin-top:16px;max-width:700px;">
    <div class="card-header"><h3>Release Notes</h3></div>
    <div id="release-notes" style="font-size:13px;"><div style="text-align:center;color:var(--text-muted);padding:20px;">Loading...</div></div>
</div>

<!-- Update History -->
<div class="card" style="margin-top:16px;max-width:700px;">
    <div class="card-header"><h3>Update History</h3></div>
    <div id="update-history"><div style="text-align:center;color:var(--text-muted);padding:20px;">Loading...</div></div>
</div>

<!-- Update Modal -->
<div class="modal-overlay" id="update-modal">
    <div class="modal" style="max-width:760px;">
        <div class="modal-header">
            <h3 id="modal-title">Running Update...</h3>
            <button class="modal-close" id="modal-close-btn" onclick="closeModal()" style="display:none;">&#x2715;</button>
        </div>
        <div class="modal-body" style="padding:0;">
            <div id="update-log"
                 style="background:var(--bg-primary);font-family:monospace;font-size:12px;line-height:1.6;
                        padding:16px;min-height:300px;max-height:460px;overflow-y:auto;
                        white-space:pre-wrap;word-break:break-all;"></div>
            <div id="modal-status-bar"
                 style="padding:12px 16px;border-top:1px solid var(--border);font-size:13px;
                        display:flex;align-items:center;gap:10px;">
                <span id="modal-spinner" style="display:inline-block;width:14px;height:14px;
                      border:2px solid var(--border);border-top-color:var(--accent);
                      border-radius:50%;animation:spin 0.8s linear infinite;"></span>
                <span id="modal-status-text" style="color:var(--text-secondary);">Starting...</span>
            </div>
        </div>
    </div>
</div>
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
{% endblock %}

{% block extra_scripts %}
<script>
const currentVersion = '{{ version }}';
let eventSource = null;
let preRestartSeen = false;
let reconnectTimer = null;

async function checkUpdate() {
    const el = document.getElementById('latest-version');
    const btn = document.getElementById('btn-check');
    btn.disabled = true; btn.textContent = 'Checking...';
    el.innerHTML = '<span style="color:var(--text-muted)">Checking...</span>';
    try {
        const r = await fetch('/api/updates/check');
        const d = await r.json();
        if (d.error) {
            el.innerHTML = '<span style="color:var(--red)">Error: ' + d.error + '</span>';
        } else if (d.update_available) {
            el.innerHTML = '<span style="color:var(--accent);font-weight:600;">v' + d.latest + ' available</span>';
            document.getElementById('update-banner').style.display = 'block';
            document.getElementById('uptodate-banner').style.display = 'none';
            document.getElementById('btn-update').style.display = 'inline-flex';
        } else {
            el.innerHTML = '<span style="color:var(--green);font-weight:500;">v' + d.latest + '</span>';
            document.getElementById('uptodate-banner').style.display = 'block';
            document.getElementById('update-banner').style.display = 'none';
            document.getElementById('btn-update').style.display = 'none';
        }
    } catch(e) {
        el.innerHTML = '<span style="color:var(--red)">Network error</span>';
    }
    btn.disabled = false; btn.textContent = 'Check Now';
}

async function runUpdate() {
    if (!confirm('Start update now? The dashboard will briefly restart.')) return;
    openModal();
    preRestartSeen = false;
    try {
        const r = await fetch('/api/updates/run', { method: 'POST' });
        const d = await r.json();
        if (!d.success) { setModalError(d.error || 'Failed to start update'); return; }
    } catch(e) {
        setModalError('Could not reach server: ' + e); return;
    }
    startStream();
}

function startStream() {
    if (eventSource) eventSource.close();
    eventSource = new EventSource('/api/updates/stream');
    eventSource.onmessage = function(e) {
        const msg = JSON.parse(e.data);
        if (msg.type === 'heartbeat') return;
        if (msg.type === 'pre_restart') {
            preRestartSeen = true;
            appendLog('— ' + msg.msg, '#eab308');
            setModalStatus('Restarting containers — dashboard will reconnect...', '#eab308');
            return;
        }
        if (msg.type === 'error') { eventSource.close(); setModalError(msg.msg); return; }
        if (msg.type === 'done')  { eventSource.close(); setModalDone(msg.msg);  return; }
        appendLog(msg.msg);
    };
    eventSource.onerror = function() {
        eventSource.close();
        if (preRestartSeen) {
            setModalStatus('Dashboard restarting — reconnecting...', '#eab308');
            pollUntilBack();
        } else {
            setModalError('Connection lost unexpectedly. Check server logs.');
        }
    };
}

function pollUntilBack() {
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(async function() {
        try {
            const r = await fetch('/api/status', { cache: 'no-store' });
            if (r.ok) { setModalDone('Update complete. Dashboard is back online.'); }
            else { pollUntilBack(); }
        } catch(e) { pollUntilBack(); }
    }, 2500);
}

function openModal() {
    document.getElementById('update-modal').classList.add('show');
    document.getElementById('update-log').textContent = '';
    document.getElementById('modal-title').textContent = 'Running Update...';
    document.getElementById('modal-close-btn').style.display = 'none';
    document.getElementById('modal-spinner').style.display = 'inline-block';
    document.getElementById('modal-status-text').textContent = 'Starting...';
    document.getElementById('modal-status-text').style.color = 'var(--text-secondary)';
    document.getElementById('modal-status-bar').style.background = '';
}

function closeModal() {
    document.getElementById('update-modal').classList.remove('show');
    if (eventSource) eventSource.close();
    clearTimeout(reconnectTimer);
    location.reload();
}

function appendLog(line, color) {
    const el = document.getElementById('update-log');
    const span = document.createElement('span');
    span.style.color = color || 'var(--text-secondary)';
    span.textContent = line + '\n';
    el.appendChild(span);
    el.scrollTop = el.scrollHeight;
}

function setModalStatus(msg, color) {
    document.getElementById('modal-status-text').textContent = msg;
    document.getElementById('modal-status-text').style.color = color || 'var(--text-secondary)';
}

function setModalDone(msg) {
    document.getElementById('modal-title').textContent = 'Update Complete';
    document.getElementById('modal-spinner').style.display = 'none';
    document.getElementById('modal-status-bar').style.background = 'rgba(34,197,94,0.08)';
    setModalStatus('✓ ' + msg, 'var(--green)');
    document.getElementById('modal-close-btn').style.display = 'block';
    appendLog('✓ ' + msg, 'var(--green)');
    setTimeout(() => { closeModal(); checkUpdate(); }, 4000);
}

function setModalError(msg) {
    document.getElementById('modal-title').textContent = 'Update Failed';
    document.getElementById('modal-spinner').style.display = 'none';
    document.getElementById('modal-status-bar').style.background = 'rgba(239,68,68,0.08)';
    setModalStatus('✗ ' + msg, 'var(--red)');
    document.getElementById('modal-close-btn').style.display = 'block';
    appendLog('✗ ' + msg, 'var(--red)');
}

async function loadReleases() {
    try {
        const r = await fetch('/api/updates/releases?limit=6');
        const d = await r.json();
        const releases = d.releases || [];
        const el = document.getElementById('release-notes');
        if (releases.length === 0) { el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No release notes available</div>'; return; }
        let html = '';
        releases.forEach((rel, i) => {
            const isCurrent = rel.version === currentVersion;
            const hl = isCurrent ? 'border-left:3px solid var(--green);padding-left:12px;' : 'padding-left:15px;';
            html += '<div style="' + hl + 'margin-bottom:16px;' + (i < releases.length-1 ? 'padding-bottom:16px;border-bottom:1px solid var(--border);' : '') + '">';
            html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
            html += '<span style="font-weight:600;font-family:monospace;color:var(--text-primary);">v' + rel.version + '</span>';
            if (isCurrent) html += '<span class="badge badge-live" style="font-size:10px;">installed</span>';
            html += '<span style="color:var(--text-muted);font-size:12px;margin-left:auto;">' + rel.date + '</span>';
            html += '</div><div style="color:var(--text-secondary);line-height:1.5;">' + rel.notes + '</div></div>';
        });
        el.innerHTML = html;
    } catch(e) { document.getElementById('release-notes').innerHTML = '<div style="color:var(--red);padding:20px;">Failed to load</div>'; }
}

async function loadHistory() {
    try {
        const r = await fetch('/api/updates/history?limit=6');
        const d = await r.json();
        const history = d.history || [];
        const el = document.getElementById('update-history');
        if (history.length === 0) { el.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No updates performed yet</div>'; return; }
        let html = '<div class="table-wrap"><table><thead><tr><th>Date</th><th>From</th><th>To</th><th>Status</th></tr></thead><tbody>';
        history.forEach(h => {
            const status = h.success ? '<span style="color:var(--green);">&#10003; Success</span>' : '<span style="color:var(--red);">&#10007; Failed</span>';
            html += '<tr><td>' + fmtTime(h.timestamp) + '</td><td style="font-family:monospace;font-size:12px;">v' + (h.from_version||'?') + '</td><td style="font-family:monospace;font-size:12px;">v' + (h.to_version||'?') + '</td><td>' + status + '</td></tr>';
        });
        html += '</tbody></table></div>';
        el.innerHTML = html;
    } catch(e) { document.getElementById('update-history').innerHTML = '<div style="color:var(--text-muted);padding:20px;">Failed to load</div>'; }
}

checkUpdate();
loadReleases();
loadHistory();
</script>
{% endblock %}
