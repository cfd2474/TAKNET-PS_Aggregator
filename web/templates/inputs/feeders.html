{% extends "base.html" %}
{% block page_title %}Feeders{% endblock %}

{% block content %}
<!-- Stat Cards -->
<div class="card-grid card-grid-3" id="feeder-stats">
    <div class="stat-card">
        <div class="label">Active</div>
        <div class="value" id="stat-active" style="color:var(--green)">—</div>
    </div>
    <div class="stat-card">
        <div class="label">Stale</div>
        <div class="value" id="stat-stale" style="color:var(--yellow)">—</div>
    </div>
    <div class="stat-card">
        <div class="label">Total</div>
        <div class="value" id="stat-total">—</div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-top:16px;">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <select class="form-control" id="filter-status" style="width:auto;min-width:120px;">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="stale">Stale</option>
            <option value="offline">Offline</option>
        </select>
        <select class="form-control" id="filter-type" style="width:auto;min-width:140px;">
            <option value="all">All Types</option>
            <option value="tailscale">Tailscale</option>
            <option value="netbird">NetBird</option>
            <option value="public">Public</option>
        </select>
        <input type="text" class="form-control" id="filter-search" placeholder="Search by name or IP..." style="width:auto;min-width:200px;flex:1;">
    </div>
</div>

<!-- Feeder Table -->
<div class="card" style="margin-top:16px;">
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>IP Address</th>
                    <th>Messages</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="feeder-table">
                <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let allFeeders = [];

async function loadFeeders() {
    try {
        const status = document.getElementById('filter-status').value;
        const type = document.getElementById('filter-type').value;
        const r = await fetch('/api/feeders?status=' + status + '&conn_type=' + type);
        const d = await r.json();

        // Update stat cards
        const s = d.stats || {};
        document.getElementById('stat-active').textContent = s.active || 0;
        document.getElementById('stat-stale').textContent = s.stale || 0;
        document.getElementById('stat-total').textContent = s.total || 0;

        allFeeders = d.feeders || [];
        renderTable();
    } catch(e) {
        console.error('Load feeders error:', e);
    }
}

function renderTable() {
    const search = document.getElementById('filter-search').value.toLowerCase();
    const filtered = allFeeders.filter(f => {
        if (!search) return true;
        return (f.name || '').toLowerCase().includes(search) ||
               (f.ip_address || '').includes(search) ||
               (f.hostname || '').toLowerCase().includes(search);
    });

    const tbody = document.getElementById('feeder-table');
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">No feeders found</td></tr>';
        return;
    }

    let html = '';
    filtered.forEach(f => {
        html += '<tr class="clickable" onclick="location.href=\'/inputs/feeder/' + f.id + '\'">';
        html += '<td style="color:var(--text-primary);font-weight:500">' + (f.name || '—') + '</td>';
        html += '<td>' + typeBadge(f.conn_type) + '</td>';
        html += '<td style="font-family:monospace;font-size:12px;">' + (f.ip_address || '—') + '</td>';
        html += '<td>' + (f.messages_received || 0).toLocaleString() + '</td>';
        html += '<td>' + fmtAgo(f.last_seen) + '</td>';
        html += '<td>' + statusBadge(f.status) + '</td>';
        html += '</tr>';
    });
    tbody.innerHTML = html;
}

document.getElementById('filter-status').addEventListener('change', loadFeeders);
document.getElementById('filter-type').addEventListener('change', loadFeeders);
document.getElementById('filter-search').addEventListener('input', renderTable);

loadFeeders();
setInterval(loadFeeders, 15000);
</script>
{% endblock %}
